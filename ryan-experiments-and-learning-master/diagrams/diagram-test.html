<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Data Explorer - Payerset</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="shared/diagram-common.css">
    <style>
        /* Test Diagram Specific Styles */
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding-top: var(--nav-height);
        }

        .diagram-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: margin-right 0.3s ease;
        }

        .diagram-area.panel-open {
            margin-right: 400px;
        }

        .diagram-area.chat-open {
            margin-bottom: 300px;
        }

        /* Data Detail Panel (Right Sidebar) */
        .data-panel {
            position: fixed;
            right: -400px;
            top: var(--nav-height);
            bottom: 0;
            width: 400px;
            background: white;
            border-left: 2px solid var(--border-light);
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            overflow-y: auto;
            transition: right 0.3s ease;
            z-index: 999;
        }

        .data-panel.open {
            right: 0;
        }

        .panel-header {
            position: sticky;
            top: 0;
            background: var(--payerset-blue);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1;
        }

        .panel-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .panel-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .panel-close:hover {
            opacity: 0.8;
        }

        .panel-content {
            padding: 20px;
        }

        .panel-section {
            margin-bottom: 25px;
        }

        .panel-section h4 {
            color: var(--payerset-blue);
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--border-light);
            padding-bottom: 5px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--bg-light);
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .metric-value {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 700;
        }

        .data-source-tag {
            display: inline-block;
            background: var(--bg-light);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            margin: 4px 4px 0 0;
            color: var(--text-secondary);
        }

        .query-btn {
            width: 100%;
            padding: 12px;
            background: var(--payerset-green);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .query-btn:hover {
            background: #0ea572;
        }

        /* Chat Interface (Bottom Drawer) */
        .chat-interface {
            position: fixed;
            bottom: -300px;
            left: 0;
            right: 0;
            height: 300px;
            background: white;
            border-top: 2px solid var(--border-light);
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            transition: bottom 0.3s ease;
            z-index: 998;
            display: flex;
            flex-direction: column;
        }

        .chat-interface.open {
            bottom: 0;
        }

        .chat-header {
            background: var(--bg-light);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-light);
        }

        .chat-header h3 {
            margin: 0;
            font-size: 16px;
            color: var(--text-primary);
        }

        .chat-toggle {
            background: var(--payerset-blue);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
        }

        .chat-toggle:hover {
            opacity: 0.9;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 8px;
            max-width: 80%;
        }

        .chat-message.user {
            background: var(--payerset-blue);
            color: white;
            margin-left: auto;
        }

        .chat-message.assistant {
            background: white;
            border: 1px solid var(--border-light);
        }

        .chat-input-area {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid var(--border-light);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border-light);
            border-radius: 6px;
            font-size: 14px;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--payerset-blue);
        }

        .chat-send {
            background: var(--payerset-green);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .chat-send:hover {
            background: #0ea572;
        }

        .chat-examples {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .chat-example {
            background: var(--bg-light);
            border: 1px solid var(--border-light);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .chat-example:hover {
            background: var(--payerset-blue);
            color: white;
            border-color: var(--payerset-blue);
        }

        /* Node styling for clickable state */
        .tooltip .click-hint {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 12px;
            color: var(--payerset-green);
            font-weight: 600;
        }

        /* Floating Action Buttons */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--payerset-blue);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .fab.chat {
            background: var(--payerset-green);
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="diagram-nav">
        <div class="nav-left">
            <a href="../index.html" class="nav-logo">Payerset</a>
            <span class="nav-divider">|</span>
            <span class="diagram-title">Interactive Data Explorer</span>
        </div>
        <div class="nav-right">
            <div class="nav-dropdown">
                <button class="nav-dropdown-toggle">
                    Diagrams
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="nav-dropdown-menu">
                    <a href="diagram1.html" class="nav-dropdown-item">
                        <i class="fas fa-network-wired"></i>
                        Ecosystem Map
                    </a>
                    <a href="diagram2.html" class="nav-dropdown-item">
                        <i class="fas fa-dollar-sign"></i>
                        Money Flows
                    </a>
                    <a href="diagram3.html" class="nav-dropdown-item">
                        <i class="fas fa-bolt"></i>
                        Power Map
                    </a>
                    <a href="diagram4.html" class="nav-dropdown-item">
                        <i class="fas fa-shield-alt"></i>
                        Conflicts Map
                    </a>
                    <a href="diagram5.html" class="nav-dropdown-item">
                        <i class="fas fa-sync-alt"></i>
                        Transformation
                    </a>
                    <a href="diagram-test.html" class="nav-dropdown-item active">
                        <i class="fas fa-flask"></i>
                        Data Explorer
                        <span class="alpha-badge">Alpha</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <!-- Main Diagram Area -->
        <div class="diagram-area" id="diagramArea">
            <div class="container" style="margin: 0; height: 100%; display: flex; flex-direction: column;">
                <div class="diagram-header">
                    <h1>ðŸ”¬ Interactive Data Explorer</h1>
                    <p>Click any stakeholder to view data â€¢ Ask questions via chat â€¢ Explore the ecosystem</p>
                </div>

                <div class="controls">
                    <div class="control-group">
                        <div class="control-label">Select View:</div>
                        <div class="layer-buttons">
                            <button class="layer-btn active" data-layer="0">
                                Executive View
                            </button>
                            <button class="layer-btn" data-layer="1">
                                Standard View
                            </button>
                            <button class="layer-btn" data-layer="2">
                                Detailed View
                            </button>
                        </div>
                    </div>

                    <div class="legend">
                        <div class="legend-label">Legend:</div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #90EE90;"></div>
                            <span>Aligned</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #FFB6C6;"></div>
                            <span>Misaligned</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #FFFFE0;"></div>
                            <span>Mixed</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #E6F3FF;"></div>
                            <span>Neutral</span>
                        </div>
                    </div>
                </div>

                <div id="cy" style="flex: 1;"></div>
                <div class="tooltip" id="tooltip"></div>

                <div class="footer">
                    <strong>How to Use:</strong> Click any node to view detailed data â€¢ Use the chat to ask questions â€¢ Toggle panels with floating buttons
                </div>
            </div>
        </div>

        <!-- Data Detail Panel (Right Sidebar) -->
        <div class="data-panel" id="dataPanel">
            <div class="panel-header">
                <h3>Stakeholder Data</h3>
                <button class="panel-close" id="panelClose">Ã—</button>
            </div>
            <div class="panel-content" id="panelContent">
                <p style="color: var(--text-secondary); text-align: center; padding: 40px 20px;">
                    Click on any stakeholder node to view detailed data and metrics
                </p>
            </div>
        </div>

        <!-- Chat Interface (Bottom Drawer) -->
        <div class="chat-interface" id="chatInterface">
            <div class="chat-header">
                <h3>ðŸ’¬ Ask about Healthcare Data</h3>
                <button class="chat-toggle" id="chatClose">Close Chat</button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message assistant">
                    <strong>Data Assistant:</strong><br>
                    Hi! I can help you explore healthcare data. Try asking:
                    <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                        <li>"What data is available for employers?"</li>
                        <li>"Show me provider pricing information"</li>
                        <li>"Explain PBM spread pricing"</li>
                    </ul>
                </div>
            </div>
            <div class="chat-input-area">
                <div class="chat-examples" id="chatExamples">
                    <!-- Dynamic examples will be inserted here -->
                </div>
                <div class="chat-input-container">
                    <textarea
                        class="chat-input"
                        id="chatInput"
                        placeholder="Ask a question about healthcare data..."
                        rows="1"></textarea>
                    <button class="chat-send" id="chatSend">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="fab-container">
        <button class="fab chat" id="fabChat" title="Open Chat">
            <i class="fas fa-comments"></i>
        </button>
        <button class="fab" id="fabData" title="Data Panel" style="display: none;">
            <i class="fas fa-database"></i>
        </button>
    </div>

    <script>
        // Enhanced node data with metadata
        const graphData = {
            0: {
                nodes: [
                    {
                        id: 'employer',
                        label: 'EMPLOYERS\n(Self-Insured)',
                        sublabel: '160M Americans\n$350B+ annual spend',
                        alignment: 'aligned',
                        description: 'Self-insured employers who pay all medical claims directly from company funds.',
                        details: [
                            'Cover ~160 million Americans',
                            'Healthcare is 2nd largest expense',
                            'Take all financial risk',
                            'Subject to ERISA fiduciary duty'
                        ],
                        metadata: {
                            type: 'Money Source',
                            covered_lives: '160M Americans',
                            annual_spend: '$350B+',
                            risk_model: 'Self-insured (full risk)',
                            fiduciary_duty: 'Yes (ERISA)',
                            data_sources: ['Employer Reporting Plans', 'TiC Files'],
                            sample_fields: ['EIN', 'reporting_plan_name', 'payer']
                        },
                        queryExamples: [
                            'Show employer healthcare spending data',
                            'What data is available for self-insured employers?',
                            'Explain ERISA fiduciary duty'
                        ]
                    },
                    {
                        id: 'employees',
                        label: 'EMPLOYEES\n& FAMILIES',
                        sublabel: '(Patients)',
                        alignment: 'aligned',
                        shape: 'ellipse',
                        description: 'Workers and families covered by employer health plans.',
                        details: [
                            '40% have less than $400 in savings',
                            'Functionally uninsured with high deductibles',
                            'Cannot shop for care effectively',
                            'May delay care due to cost'
                        ],
                        metadata: {
                            type: 'Patients / Cost-Sharers',
                            cost_sharing: '20-30% of premiums',
                            deductible_impact: 'High deductibles = functional uninsurance',
                            savings_challenge: '40% have <$400 in savings',
                            transparency_need: 'Cannot shop without price data'
                        },
                        queryExamples: [
                            'What are typical patient cost-sharing amounts?',
                            'How do deductibles affect care access?'
                        ]
                    },
                    {
                        id: 'middlemen',
                        label: 'MIDDLEMEN',
                        sublabel: 'Carriers/TPAs/PBMs\nâš ï¸ Take NO risk',
                        alignment: 'misaligned',
                        description: 'Administrative intermediaries who take NO financial risk but extract value.',
                        details: [
                            'Process claims and manage networks',
                            'Take ZERO financial risk',
                            'Extract 20-40% through spread pricing',
                            'Control data and payment flows'
                        ],
                        metadata: {
                            type: 'Administrative Intermediaries',
                            risk_taken: 'ZERO (employer takes all)',
                            value_extraction: '20-40% via spread pricing',
                            data_control: 'Yes (withhold up to 10+ months)',
                            data_sources: ['TiC Files', 'Claims Data', 'TIN-NPI Maps'],
                            key_metrics: ['negotiated_rate', 'spread_amount', 'float_income']
                        },
                        queryExamples: [
                            'Show me TPA spread pricing data',
                            'What is spread pricing?',
                            'Compare negotiated rates across payers'
                        ]
                    },
                    {
                        id: 'providers',
                        label: 'PROVIDERS',
                        sublabel: 'Hospitals & Physicians',
                        alignment: 'mixed',
                        description: 'Hospitals and physicians who deliver actual healthcare services.',
                        details: [
                            'Deliver actual medical care',
                            'Increasingly consolidated',
                            'Price and quality often not correlated',
                            '1 admin per 2 physicians'
                        ],
                        metadata: {
                            type: 'Care Delivery',
                            consolidation: 'Increasing market power',
                            pricing_range: 'Wide variation (min/max/median)',
                            quality_data: 'Leapfrog grades (future)',
                            data_sources: ['Hospital Transparency', 'NPPES', 'NUCC Taxonomy', 'Claims Data'],
                            key_fields: ['NPI', 'HOSPITAL_ID', 'GROSS', 'NEGOTIATED_RATE', 'taxonomy_code']
                        },
                        queryExamples: [
                            'Show me hospital pricing data',
                            'What quality metrics are available?',
                            'Compare provider rates for a procedure'
                        ]
                    },
                    {
                        id: 'regulators',
                        label: 'REGULATORS',
                        sublabel: 'DOL, CMS',
                        alignment: 'neutral',
                        shape: 'ellipse',
                        description: 'Federal agencies that set rules and enforce transparency requirements.',
                        details: [
                            'DOL: ERISA fiduciary enforcement',
                            'CMS: Hospital price transparency',
                            'CAA: Machine-readable files required',
                            'Increasing enforcement post-2021'
                        ],
                        metadata: {
                            type: 'Oversight & Regulation',
                            key_agencies: 'DOL, CMS, FTC',
                            major_rules: 'CAA 2021, Hospital Transparency',
                            enforcement: 'Increasing (2021+)',
                            transparency_requirements: 'Machine-readable files (MRFs)'
                        },
                        queryExamples: [
                            'What are CAA transparency requirements?',
                            'Explain hospital price transparency rules'
                        ]
                    }
                ],
                edges: [
                    { source: 'employer', target: 'middlemen', label: 'Pays for\neverything', type: 'visible' },
                    { source: 'employer', target: 'employees', label: 'Employs &\ninsures', type: 'visible' },
                    { source: 'middlemen', target: 'providers', label: 'Manages\nnetwork & claims', type: 'visible' },
                    { source: 'providers', target: 'employees', label: 'Delivers\ncare to', type: 'visible' },
                    { source: 'regulators', target: 'employer', label: 'Oversees &\nrequires transparency', type: 'oversight' },
                    { source: 'regulators', target: 'middlemen', label: 'Enforces\nrules on', type: 'oversight' }
                ]
            },
            // Add layers 1 and 2 data here (abbreviated for now)
            1: { nodes: [], edges: [] },
            2: { nodes: [], edges: [] }
        };

        // Mock data responses for RAG queries
        const mockResponses = {
            'employer': {
                spending: 'According to Payerset data, self-insured employers covering ~160M Americans spend $350B+ annually on healthcare. This makes healthcare the 2nd largest expense after payroll. Data sources: Employer Reporting Plans showing EIN, reporting_plan_name, and payer relationships.',
                data: 'Available employer data includes: EIN (Employer Identification Number), reporting_plan_name, associated payers, and TPA relationships. This data comes from the Employer Reporting Plans dataset, updated monthly.',
                fiduciary: 'Under ERISA and the Consolidated Appropriations Act (CAA) 2021, self-insured employers have a fiduciary duty to act in the best interest of plan participants. This includes ensuring reasonable costs and transparency in healthcare spending.'
            },
            'providers': {
                pricing: 'Hospital transparency data shows wide pricing variation. Key fields include: GROSS charge, DISCOUNTED_CASH price, and MIN/MAX negotiated rates by payer. Access via Hospital Transparency MRFs (quarterly updates).',
                quality: 'Quality data integration is planned. Leapfrog safety grades (A-F) will be linked to NPIs. Currently available: NPPES data (7M NPIs) and NUCC taxonomy classifications (16 groupings, 120+ classifications).',
                comparison: 'Use Claims Data (premium tier) to compare: AVG_CLAIM_AMOUNT, MIN/MAX/AVG/MEDIAN_REMIT_AMOUNT across providers. Data available quarterly with volume benchmarking.'
            },
            'middlemen': {
                spread: 'Spread pricing: TPAs/PBMs charge employers MORE than they pay providers. Example: Employer pays $100 â†’ TPA keeps $30 â†’ Provider gets $70. Calculate via: negotiated_rate - remit_amount. Data source: TiC Files + Claims Data.',
                tpa: 'TPA data available in TiC files: PAYER name, NEGOTIATED_RATE, NEGOTIATION_ARRANGEMENT, NPI/TIN mappings. Compare rates across payers to identify spread pricing patterns.',
                network: 'Network size can be calculated from TIN-NPI maps. Fields: tin_value, npi, payer_list, payer_count, record_count. Shows which providers are in which networks.'
            },
            'general': {
                caa: 'The Consolidated Appropriations Act (CAA) 2021 requires group health plans to publish machine-readable files (MRFs) with negotiated rates. Files include: in-network rates, out-of-network allowed amounts, and prescription drugs.',
                transparency: 'Hospital Price Transparency (2021) requires hospitals to publish: standard charges (GROSS), discounted cash prices, and payer-specific negotiated rates for all items/services. Updated quarterly.'
            }
        };

        // UI State
        let cy;
        let currentLayer = 0;
        let selectedNode = null;
        let dataPanelOpen = false;
        let chatOpen = false;

        // Initialize
        async function initCytoscape(layerNum) {
            const data = graphData[layerNum];

            const elements = [
                ...data.nodes.map(n => ({
                    data: {
                        id: n.id,
                        label: n.label,
                        sublabel: n.sublabel || '',
                        alignment: n.alignment,
                        shape: n.shape || 'rectangle',
                        description: n.description || '',
                        details: n.details || [],
                        metadata: n.metadata || {},
                        queryExamples: n.queryExamples || []
                    }
                })),
                ...data.edges.map(e => ({
                    data: {
                        id: `${e.source}-${e.target}`,
                        source: e.source,
                        target: e.target,
                        label: e.label || '',
                        type: e.type || 'visible'
                    }
                }))
            ];

            if (cy) cy.destroy();

            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '12px',
                            'font-weight': 'bold',
                            'text-wrap': 'wrap',
                            'text-max-width': '120px',
                            'width': 'label',
                            'height': 'label',
                            'padding': '15px',
                            'border-width': 3,
                            'border-color': '#333',
                            'cursor': 'pointer',
                            'transition-property': 'background-color, border-color, border-width',
                            'transition-duration': '0.3s'
                        }
                    },
                    {
                        selector: 'node[alignment="aligned"]',
                        style: {
                            'background-color': '#90EE90',
                            'border-color': '#228B22'
                        }
                    },
                    {
                        selector: 'node[alignment="misaligned"]',
                        style: {
                            'background-color': '#FFB6C6',
                            'border-color': '#DC143C'
                        }
                    },
                    {
                        selector: 'node[alignment="mixed"]',
                        style: {
                            'background-color': '#FFFFE0',
                            'border-color': '#DAA520'
                        }
                    },
                    {
                        selector: 'node[alignment="neutral"]',
                        style: {
                            'background-color': '#E6F3FF',
                            'border-color': '#4A90E2'
                        }
                    },
                    {
                        selector: 'node[shape="ellipse"]',
                        style: { 'shape': 'ellipse' }
                    },
                    {
                        selector: 'node:hover',
                        style: {
                            'border-width': 5,
                            'border-color': 'var(--payerset-blue)'
                        }
                    },
                    {
                        selector: 'node.selected',
                        style: {
                            'border-width': 6,
                            'border-color': 'var(--payerset-green)',
                            'background-color': '#fff'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 2,
                            'line-color': '#666',
                            'target-arrow-color': '#666',
                            'target-arrow-shape': 'triangle',
                            'curve-style': 'bezier',
                            'label': 'data(label)',
                            'font-size': '10px',
                            'text-background-color': '#fff',
                            'text-background-opacity': 0.8,
                            'text-background-padding': '3px',
                            'text-wrap': 'wrap',
                            'text-max-width': '80px'
                        }
                    },
                    {
                        selector: 'edge[type="visible"]',
                        style: {
                            'line-style': 'solid',
                            'width': 3,
                            'line-color': '#333'
                        }
                    },
                    {
                        selector: 'edge[type="hidden"]',
                        style: {
                            'line-style': 'dashed',
                            'line-dash-pattern': [6, 3],
                            'line-color': '#DC143C',
                            'width': 2
                        }
                    },
                    {
                        selector: 'edge[type="oversight"]',
                        style: {
                            'line-style': 'dotted',
                            'line-color': '#4A90E2',
                            'width': 2
                        }
                    }
                ],
                layout: {
                    name: 'cose',
                    animate: true,
                    animationDuration: 1000,
                    nodeRepulsion: 10000,
                    idealEdgeLength: 180,
                    edgeElasticity: 150,
                    gravity: 0.8,
                    numIter: 1500
                },
                wheelSensitivity: 0.2,
                minZoom: 0.3,
                maxZoom: 3
            });

            setupInteractivity();
        }

        function setupInteractivity() {
            const tooltip = document.getElementById('tooltip');

            cy.on('mouseover', 'node', function(evt) {
                const node = evt.target;
                const data = node.data();

                let content = `<h4>${data.label}</h4>`;
                if (data.description) {
                    content += `<p style="margin: 8px 0;">${data.description}</p>`;
                }
                if (data.details && data.details.length > 0) {
                    content += '<ul>';
                    data.details.forEach(detail => {
                        content += `<li>${detail}</li>`;
                    });
                    content += '</ul>';
                }
                content += '<div class="click-hint">ðŸ‘† Click to view detailed data</div>';

                tooltip.innerHTML = content;
                tooltip.style.display = 'block';
            });

            cy.on('mousemove', 'node', function(evt) {
                tooltip.style.left = evt.originalEvent.pageX + 15 + 'px';
                tooltip.style.top = evt.originalEvent.pageY + 15 + 'px';
            });

            cy.on('mouseout', 'node', function() {
                tooltip.style.display = 'none';
            });

            cy.on('tap', 'node', function(evt) {
                const node = evt.target;
                showDataPanel(node);
            });
        }

        function showDataPanel(node) {
            const data = node.data();
            const metadata = data.metadata || {};

            // Highlight selected node
            cy.nodes().removeClass('selected');
            node.addClass('selected');
            selectedNode = node;

            // Build panel content
            let html = `
                <div class="panel-section">
                    <h4>Stakeholder Type</h4>
                    <div class="metric-row">
                        <span class="metric-label">Category</span>
                        <span class="metric-value">${metadata.type || 'N/A'}</span>
                    </div>
                </div>
            `;

            // Add key metrics
            if (Object.keys(metadata).length > 1) {
                html += '<div class="panel-section"><h4>Key Metrics</h4>';
                for (let [key, value] of Object.entries(metadata)) {
                    if (key !== 'type' && key !== 'data_sources' && key !== 'sample_fields' && key !== 'key_fields' && key !== 'key_metrics') {
                        const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        html += `
                            <div class="metric-row">
                                <span class="metric-label">${label}</span>
                                <span class="metric-value">${value}</span>
                            </div>
                        `;
                    }
                }
                html += '</div>';
            }

            // Add data sources
            if (metadata.data_sources && metadata.data_sources.length > 0) {
                html += '<div class="panel-section"><h4>Data Sources</h4>';
                metadata.data_sources.forEach(source => {
                    html += `<span class="data-source-tag">${source}</span>`;
                });
                html += '</div>';
            }

            // Add sample fields
            if (metadata.sample_fields || metadata.key_fields || metadata.key_metrics) {
                html += '<div class="panel-section"><h4>Available Fields</h4>';
                const fields = metadata.sample_fields || metadata.key_fields || metadata.key_metrics;
                fields.forEach(field => {
                    html += `<span class="data-source-tag"><code>${field}</code></span>`;
                });
                html += '</div>';
            }

            // Add query button
            html += `
                <button class="query-btn" onclick="openChatWithNode('${data.id}')">
                    <i class="fas fa-comments"></i>
                    Ask Questions About This Data
                </button>
            `;

            document.getElementById('panelContent').innerHTML = html;
            document.getElementById('dataPanel').classList.add('open');
            document.getElementById('diagramArea').classList.add('panel-open');
            document.getElementById('fabData').style.display = 'flex';
            dataPanelOpen = true;
        }

        function closeDataPanel() {
            document.getElementById('dataPanel').classList.remove('open');
            document.getElementById('diagramArea').classList.remove('panel-open');
            if (selectedNode) {
                cy.nodes().removeClass('selected');
                selectedNode = null;
            }
            dataPanelOpen = false;
        }

        function openChatWithNode(nodeId) {
            const node = cy.getElementById(nodeId);
            const data = node.data();
            const queryExamples = data.queryExamples || [];

            // Update chat examples
            const examplesContainer = document.getElementById('chatExamples');
            examplesContainer.innerHTML = '';
            queryExamples.forEach(example => {
                const btn = document.createElement('button');
                btn.className = 'chat-example';
                btn.textContent = example;
                btn.onclick = () => sendQuery(example);
                examplesContainer.appendChild(btn);
            });

            openChat();
        }

        function openChat() {
            document.getElementById('chatInterface').classList.add('open');
            document.getElementById('diagramArea').classList.add('chat-open');
            document.getElementById('chatInput').focus();
            chatOpen = true;
        }

        function closeChat() {
            document.getElementById('chatInterface').classList.remove('open');
            document.getElementById('diagramArea').classList.remove('chat-open');
            chatOpen = false;
        }

        function sendQuery(query) {
            const input = document.getElementById('chatInput');
            const queryText = query || input.value.trim();
            if (!queryText) return;

            // Add user message
            const messagesContainer = document.getElementById('chatMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.textContent = queryText;
            messagesContainer.appendChild(userMsg);

            // Generate mock response
            const response = generateMockResponse(queryText);
            setTimeout(() => {
                const assistantMsg = document.createElement('div');
                assistantMsg.className = 'chat-message assistant';
                assistantMsg.innerHTML = `<strong>Data Assistant:</strong><br>${response}`;
                messagesContainer.appendChild(assistantMsg);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 500);

            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function generateMockResponse(query) {
            const lowerQuery = query.toLowerCase();

            // Match keywords to responses
            if (lowerQuery.includes('employer') && lowerQuery.includes('spend')) {
                return mockResponses.employer.spending;
            } else if (lowerQuery.includes('employer') && lowerQuery.includes('data')) {
                return mockResponses.employer.data;
            } else if (lowerQuery.includes('fiduciary')) {
                return mockResponses.employer.fiduciary;
            } else if (lowerQuery.includes('provider') || lowerQuery.includes('hospital')) {
                if (lowerQuery.includes('pric')) return mockResponses.providers.pricing;
                if (lowerQuery.includes('quality')) return mockResponses.providers.quality;
                if (lowerQuery.includes('compar')) return mockResponses.providers.comparison;
                return mockResponses.providers.pricing;
            } else if (lowerQuery.includes('spread')) {
                return mockResponses.middlemen.spread;
            } else if (lowerQuery.includes('tpa') || lowerQuery.includes('middlem')) {
                return mockResponses.middlemen.tpa;
            } else if (lowerQuery.includes('network')) {
                return mockResponses.middlemen.network;
            } else if (lowerQuery.includes('caa')) {
                return mockResponses.general.caa;
            } else if (lowerQuery.includes('transparency')) {
                return mockResponses.general.transparency;
            } else {
                return `I can help you explore healthcare data! Try asking about specific stakeholders (employers, providers, middlemen), data sources (TiC files, claims data), or regulations (CAA, transparency rules).`;
            }
        }

        // Event listeners
        document.getElementById('panelClose').addEventListener('click', closeDataPanel);
        document.getElementById('chatClose').addEventListener('click', closeChat);
        document.getElementById('fabChat').addEventListener('click', () => {
            if (chatOpen) closeChat();
            else openChat();
        });
        document.getElementById('fabData').addEventListener('click', () => {
            if (dataPanelOpen) closeDataPanel();
            else if (selectedNode) showDataPanel(selectedNode);
        });
        document.getElementById('chatSend').addEventListener('click', () => sendQuery());
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendQuery();
            }
        });

        // Layer switching
        document.querySelectorAll('.layer-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const layer = parseInt(this.dataset.layer);
                document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentLayer = layer;
                initCytoscape(layer);
            });
        });

        // Dropdown navigation toggle
        const dropdown = document.querySelector('.nav-dropdown');
        const dropdownToggle = document.querySelector('.nav-dropdown-toggle');
        dropdownToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdown.classList.toggle('open');
        });
        document.addEventListener('click', (e) => {
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        // Initialize
        initCytoscape(0);
    </script>
</body>
</html>
